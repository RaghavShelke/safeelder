<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Senior Health Monitor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons (as a library for easy SVG access) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Tone.js for critical sound alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Load D3.js for data visualization (Charts) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Custom styles for high contrast and readability */
        :root {
            --primary: #8B5CF6; /* Violet-500 */
            --danger: #EF4444; /* Red-500 */
            --warning: #F59E0B; /* Amber-500 */
            --normal: #10B981; /* Emerald-500 */
            font-family: 'Inter', sans-serif;
        }

        /* NEW: Subtle gradient background for a modern feel */
        body {
            background-color: #111827; /* Gray-900 */
            /* Added a subtle gradient that complements the glass UI */
            background-image: linear-gradient(135deg, #111827 0%, #111827 70%, #1f1f3a 100%);
        }

        /* NEW: Glassmorphism Card Style */
        .glass-card {
            background: rgba(31, 41, 55, 0.4); /* Gray-800 with 40% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .glass-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Sidebar glass is slightly different */
        .sidebar-glass {
            background: rgba(31, 41, 55, 0.6); /* Gray-800 with 60% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Specific styling for the emergency button (Unchanged) */
        #emergencyButton {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }
        
        /* Alert list item glow for visibility (Unchanged) */
        .alert-pulse {
            animation: glow-red 1.5s infinite alternate;
        }

        @keyframes glow-red {
            0% {
                box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
            }
            100% {
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.9);
            }
        }
        
        /* NEW: Animated border pulse for warning/critical states */
        @keyframes pulse-border-yellow {
            0%, 100% { border-color: var(--warning); box-shadow: 0 0 5px var(--warning); }
            50% { border-color: var(--warning); box-shadow: 0 0 15px var(--warning); }
        }
        @keyframes pulse-border-red {
            0%, 100% { border-color: var(--danger); box-shadow: 0 0 5px var(--danger); }
            50% { border-color: var(--danger); box-shadow: 0 0 15px var(--danger); }
        }
        
        .animate-pulse-border-yellow {
            animation: pulse-border-yellow 2s infinite;
        }
        .animate-pulse-border-red {
            animation: pulse-border-red 1.5s infinite;
        }

        /* NEW: Dynamic Heartbeat Animation */
        @keyframes live-heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        .live-heartbeat-icon {
            /* Animation duration will be set dynamically via JS */
            animation: live-heartbeat 1s infinite ease-in-out;
        }


        /* D3 Chart Specific Styles (ENHANCED) */
        .axis path, .axis line {
            fill: none;
            stroke: #4B5563; /* Gray-600 (Lighter for glass) */
            shape-rendering: crispEdges;
        }
        .axis text {
            fill: #D1D5DB; /* Gray-300 (Lighter) */
            font-size: 10px;
        }
        .line-heartrate {
            fill: none;
            stroke: var(--primary); /* Violet */
            stroke-width: 4px; /* Thicker line */
            stroke-linecap: round;
        }
        /* NEW: Gradient area under the line */
        .area-heartrate {
            fill: url(#hrGradient);
        }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col lg:flex-row">

    <!-- Sidebar Navigation (Updated with Glass) -->
    <div id="sidebar" class="sidebar-glass p-4 lg:w-64 w-full lg:h-screen flex lg:flex-col justify-around lg:justify-start lg:space-y-4 shadow-2xl z-10 sticky top-0">
        <h1 class="text-3xl font-bold text-violet-400 hidden lg:block mb-6">CareMonitor</h1>
        
        <button id="navUser" onclick="showDashboard('user')" class="nav-button p-3 rounded-xl flex items-center justify-center lg:justify-start space-x-3 text-lg font-medium transition-all bg-violet-600 hover:bg-violet-700">
            <i data-lucide="user-round" class="w-6 h-6"></i>
            <span class="hidden lg:inline">User (Patient)</span>
        </button>

        <button id="navCaretaker" onclick="showDashboard('caretaker')" class="nav-button p-3 rounded-xl flex items-center justify-center lg:justify-start space-x-3 text-lg font-medium transition-all hover:bg-gray-700 relative">
            <i data-lucide="heart-handshake" class="w-6 h-6"></i>
            <span class="hidden lg:inline">Caretaker</span>
            <span id="caretakerAlertBadge" class="hidden absolute top-0 right-0 lg:static ml-2 bg-red-500 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
        </button>

        <button id="navHospital" onclick="showDashboard('hospital')" class="nav-button p-3 rounded-xl flex items-center justify-center lg:justify-start space-x-3 text-lg font-medium transition-all hover:bg-gray-700 relative">
            <i data-lucide="hospital" class="w-6 h-6"></i>
            <span class="hidden lg:inline">Hospital</span>
            <span id="hospitalAlertBadge" class="hidden absolute top-0 right-0 lg:static ml-2 bg-red-500 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
        </button>
        
        <div class="lg:mt-auto pt-4 border-t border-gray-700 hidden lg:block">
            <p class="text-sm text-gray-400">System Status: <span class="text-green-400">Active</span></p>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="mainContent" class="flex-1 p-4 sm:p-8 overflow-y-auto">

        <!-- Emergency Alert Modal (Unchanged) -->
        <div id="globalAlert" class="hidden fixed inset-0 bg-red-900/90 backdrop-blur-sm z-30 flex items-center justify-center p-4">
            <div class="bg-red-700 border-4 border-red-300 p-8 rounded-2xl shadow-2xl text-center max-w-lg w-full transform transition-all scale-100">
                <i data-lucide="octagon-alert" class="w-20 h-20 mx-auto text-red-100 mb-4 animate-bounce"></i>
                <h2 class="text-4xl font-extrabold text-red-100 mb-2">EMERGENCY ALERT!</h2>
                <p id="alertReason" class="text-2xl font-semibold text-red-200 mb-6">Patient critical status detected.</p>
                <button onclick="dismissAlert()" class="bg-red-900 hover:bg-red-800 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">
                    Acknowledge and Clear
                </button>
            </div>
        </div>

        <!-- Dashboard Containers -->
        <div id="userDashboard" class="dashboard-container space-y-8">
            <h1 class="text-4xl font-extrabold text-violet-300 mb-6">Hello, Mr. John Doe</h1>
            
            <!-- Contact & Quick Info Header (Updated with Glass) -->
            <div class="glass-card p-6 rounded-2xl shadow-xl flex flex-col md:flex-row justify-around items-center space-y-4 md:space-y-0 text-center">
                <div class="text-center">
                    <p class="text-gray-400 text-sm">Primary Caretaker</p>
                    <p class="text-xl font-bold text-green-400">Sarah Doe</p>
                    <p class="text-sm text-gray-300">Call: (555) 123-4567</p>
                </div>
                <div class="h-10 w-px bg-gray-700 hidden md:block"></div>
                <div class="text-center">
                    <p class="text-gray-400 text-sm">Monitoring Hospital</p>
                    <p class="text-xl font-bold text-violet-400">City General</p>
                    <p class="text-sm text-gray-300">Emergency: (555) 911-0000</p>
                </div>
            </div>

            <!-- Vitals and Emergency Button (Updated with Glass) -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <!-- Heart Rate Card -->
                <div id="hrCard" class="glass-card p-6 rounded-2xl border-l-4 border-green-500 lg:col-span-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <!-- NEW: Added id="hrIcon" for JS animation control -->
                        <i id="hrIcon" data-lucide="heart" class="w-8 h-8 text-green-400"></i>
                        <h3 class="text-2xl font-semibold text-gray-300">Heart Rate</h3>
                    </div>
                    <p id="hrValue" class="text-6xl font-extrabold text-white">72 <span class="text-3xl text-gray-400">BPM</span></p>
                    <p id="hrStatus" class="text-base text-green-400 mt-2 font-medium">Normal Range</p>
                </div>

                <!-- Blood Pressure Card -->
                <div id="bpCard" class="glass-card p-6 rounded-2xl border-l-4 border-green-500 lg:col-span-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="gauge" class="w-8 h-8 text-green-400"></i>
                        <h3 class="text-2xl font-semibold text-gray-300">Blood Pressure</h3>
                    </div>
                    <p id="bpValue" class="text-6xl font-extrabold text-white">120/80 <span class="text-3xl text-gray-400">mmHg</span></p>
                    <p id="bpStatus" class="text-base text-green-400 mt-2 font-medium">Normal Range</p>
                </div>

                <!-- Fall Detection Card -->
                <div id="fallCard" class="glass-card p-6 rounded-2xl border-l-4 border-green-500 lg:col-span-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="accessibility" class="w-8 h-8 text-green-400"></i>
                        <h3 class="text-2xl font-semibold text-gray-300">Fall Detection</h3>
                    </div>
                    <p id="fallValue" class="text-6xl font-extrabold text-white">OK</p>
                    <p id="fallStatus" class="text-base text-green-400 mt-2 font-medium">No Incident</p>
                </div>

                <!-- Emergency Button (Unchanged) -->
                <button id="emergencyButton" onclick="simulateAlert('Emergency Button Pressed')" class="col-span-1 bg-red-600 hover:bg-red-700 text-white font-extrabold text-3xl rounded-2xl transition-all transform hover:scale-[1.02]">
                    <i data-lucide="siren" class="w-10 h-10 mx-auto mb-2"></i>
                    PRESS FOR HELP
                </button>
            </div>
            
            <!-- Vitals Chart and Location Map (Updated with Glass) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Heart Rate Chart -->
                <div class="glass-card p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-semibold text-violet-300 mb-4">Heart Rate Trend (Last 30 Min)</h3>
                    <div id="hrChartUser" class="w-full aspect-[2/1]">
                        <!-- D3 Chart will be injected here -->
                    </div>
                </div>

                <!-- Location Map (Simulated) -->
                <div class="glass-card p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-semibold text-violet-300 mb-4 flex items-center">
                        <i data-lucide="map-pin" class="w-5 h-5 mr-2"></i>
                        Current Location
                    </h3>
                    <!-- NEW: Replaced placeholder with a 'tech' gradient map -->
                    <div id="locationMap" class="w-full aspect-[2/1] bg-gray-900 rounded-lg relative overflow-hidden">
                        <!-- Simulated Map Container -->
                        <div class="absolute inset-0 opacity-60" style="background-image: radial-gradient(circle at 25% 25%, #4B5563 2px, transparent 0), radial-gradient(circle at 75% 75%, #4B5563 2px, transparent 0), linear-gradient(45deg, #1f2937, #374151);"></div>
                        <div id="patientMarker" class="absolute w-5 h-5 rounded-full bg-violet-500 border-4 border-white animate-pulse" style="top: 50%; left: 50%;"></div>
                        <div id="locationText" class="absolute bottom-2 left-2 bg-gray-800/80 backdrop-blur-sm p-2 rounded-lg text-sm font-medium">
                            Location: Living Room (50%, 50%)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Status Log (Large, Simple) (Updated with Glass) -->
            <div class="glass-card p-6 rounded-2xl shadow-xl">
                <h3 class="text-2xl font-semibold text-violet-300 mb-4">Latest Activity</h3>
                <div id="activityLog" class="text-lg space-y-2 max-h-48 overflow-y-auto">
                    <p class="text-gray-400">[00:00:00] System Initialized. Readings are nominal.</p>
                </div>
            </div>

            <!-- Sim Buttons (Unchanged) -->
            <div class="flex justify-center pt-4">
                <button onclick="simulateHealthChange('warn')" class="bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-xl mr-4 text-sm font-medium">Simulate Warning (High BP)</button>
                <button onclick="simulateHealthChange('critical')" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-xl text-sm font-medium">Simulate Critical (Fall/HR)</button>
            </div>
        </div>

        <!-- Caretaker Dashboard (Updated with Glass) -->
        <div id="caretakerDashboard" class="dashboard-container space-y-8 hidden">
            <h1 class="text-4xl font-extrabold text-violet-300 mb-6">Caretaker Dashboard: John Doe</h1>
            
            <!-- Current Status Overview & Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <div class="glass-card p-6 rounded-2xl shadow-xl lg:col-span-1">
                    <h3 class="text-2xl font-semibold text-violet-300 mb-4">Current Health Status</h3>
                    <div class="space-y-4">
                        <div class="p-3 bg-gray-900/50 rounded-lg">
                            <p class="text-sm text-gray-400">Heart Rate</p>
                            <p id="ctHrValue" class="text-2xl font-bold text-green-400">72 BPM</p>
                        </div>
                        <div class="p-3 bg-gray-900/50 rounded-lg">
                            <p class="text-sm text-gray-400">Blood Pressure</p>
                            <p id="ctBpValue" class="text-2xl font-bold text-green-400">120/80 mmHg</p>
                        </div>
                        <div class="p-3 bg-gray-900/50 rounded-lg">
                            <p class="text-sm text-gray-400">Last Incident</p>
                            <p id="ctLastIncident" class="text-2xl font-bold text-gray-300">None (00:00)</p>
                        </div>
                    </div>
                </div>
                <!-- Heart Rate Chart for Caretaker -->
                <div class="glass-card p-6 rounded-2xl shadow-xl lg:col-span-2">
                    <h3 class="text-xl font-semibold text-violet-300 mb-4">Heart Rate Trend (Last 30 Min)</h3>
                    <div id="hrChartCaretaker" class="w-full aspect-[3/1]">
                        <!-- D3 Chart will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Schedule and Alerts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Schedule Panel -->
                <div class="glass-card p-6 rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-semibold text-violet-300 mb-4 flex items-center">
                        <i data-lucide="calendar-check" class="w-6 h-6 mr-2"></i>
                        Schedule & Reminders
                    </h3>
                    <ul class="space-y-3">
                        <li class="p-3 bg-gray-900/50 rounded-lg flex justify-between items-center text-gray-300">
                            <span>08:00 AM - Medication (Pill A)</span>
                            <span class="text-green-400 font-medium">Done</span>
                        </li>
                        <li class="p-3 bg-gray-900/50 rounded-lg flex justify-between items-center text-gray-300">
                            <span>10:30 AM - Doctor Appointment (Dr. Lee)</span>
                            <span class="text-yellow-400 font-medium">Upcoming</span>
                        </li>
                        <li class="p-3 bg-gray-900/50 rounded-lg flex justify-between items-center text-gray-300">
                            <span>07:00 PM - Medication (Pill B)</span>
                            <span class="text-red-400 font-medium">Due soon</span>
                        </li>
                    </ul>
                </div>

                <!-- Alerts Panel -->
                <div class="glass-card p-6 rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-semibold text-red-500 mb-4 flex items-center">
                        <i data-lucide="bell-ring" class="w-6 h-6 mr-2"></i>
                        URGENT ALERTS (<span id="alertCountCaretaker">0</span>)
                    </h3>
                    <ul id="caretakerAlertList" class="space-y-3 max-h-80 overflow-y-auto">
                        <li class="p-3 bg-gray-900/50 rounded-lg text-gray-400">No recent critical alerts.</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Hospital Dashboard (Updated with Glass) -->
        <div id="hospitalDashboard" class="dashboard-container space-y-8 hidden">
            <h1 class="text-4xl font-extrabold text-violet-300 mb-6">Hospital Triage Dashboard</h1>

            <!-- Simulated Patient List -->
            <div class="glass-card p-6 rounded-2xl shadow-xl">
                <h3 class="text-2xl font-semibold text-violet-300 mb-4">Monitored Patients Overview</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700/50">
                        <thead>
                            <tr class="text-left text-gray-400 uppercase tracking-wider text-sm">
                                <th class="py-3 px-4">Patient Name</th>
                                <th class="py-3 px-4">Status</th>
                                <th class="py-3 px-4">Last HR/BP</th>
                                <th class="py-3 px-4">Latest Incident</th>
                                <th class="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalPatientList" class="divide-y divide-gray-700/50 text-lg">
                            <!-- John Doe (Our main user) -->
                            <tr id="patientRowJohnDoe" class="hover:bg-gray-700/50 transition-colors">
                                <td class="py-4 px-4 font-medium">John Doe</td>
                                <td id="hospStatusJohnDoe" class="py-4 px-4 text-green-400 font-bold">STABLE</td>
                                <td id="hospVitalsJohnDoe" class="py-4 px-4">72 BPM / 120/80</td>
                                <td id="hospIncidentJohnDoe" class="py-4 px-4 text-gray-400">None</td>
                                <td class="py-4 px-4">
                                    <button class="bg-violet-600 hover:bg-violet-700 text-white text-sm font-medium py-1 px-3 rounded-lg">View Profile</button>
                                </td>
                            </tr>
                            <!-- Other simulated patients -->
                            <tr class="hover:bg-gray-700/50 transition-colors">
                                <td class="py-4 px-4 font-medium">Alice Smith</td>
                                <td class="py-4 px-4 text-gray-400">Offline</td>
                                <td class="py-4 px-4">--</td>
                                <td class="py-4 px-4 text-gray-400">None</td>
                                <td class="py-4 px-4"><button class="bg-gray-600 text-gray-400 text-sm font-medium py-1 px-3 rounded-lg cursor-not-allowed">View Profile</button></td>
                            </tr>
                            <tr class="hover:bg-gray-700/50 transition-colors">
                                <td class="py-4 px-4 font-medium">Robert Brown</td>
                                <td class="py-4 px-4 text-green-400 font-bold">STABLE</td>
                                <td class="py-4 px-4">68 BPM / 125/85</td>
                                <td class="py-4 px-4 text-gray-400">None</td>
                                <td class="py-4 px-4"><button class="bg-violet-600 hover:bg-violet-700 text-white text-sm font-medium py-1 px-3 rounded-lg">View Profile</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Hospital Alerts List -->
            <div class="glass-card p-6 rounded-2xl shadow-xl">
                <h3 class="text-2xl font-semibold text-red-500 mb-4 flex items-center">
                    <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                    CRITICAL INCIDENTS LOG (<span id="alertCountHospital">0</span>)
                </h3>
                <ul id="hospitalAlertList" class="space-y-3 max-h-80 overflow-y-auto">
                    <li class="p-3 bg-gray-900/50 rounded-lg text-gray-400">No critical alerts requiring action.</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // --- Core Data Model (Simulated) ---
        const Patient = {
            name: "John Doe",
            hr: 72,
            bpSystolic: 120,
            bpDiastolic: 80,
            fallDetected: false,
            status: 'NORMAL', // NORMAL, WARNING, CRITICAL
            alerts: [],
            lastUpdate: new Date(),
            
            // NEW: Historical data storage (stores last 60 points = ~5 minutes of data)
            hrHistory: [], 
            
            // NEW: Simulated Location Data (percentage of container width/height)
            location: {
                x: 50,
                y: 50,
                room: 'Living Room'
            }
        };

        // --- DOMElements (UPDATED) ---
        const DOMElements = {
            // User Dashboard
            hrCard: document.getElementById('hrCard'),
            bpCard: document.getElementById('bpCard'),
            fallCard: document.getElementById('fallCard'),
            hrValue: document.getElementById('hrValue'),
            bpValue: document.getElementById('bpValue'),
            hrStatus: document.getElementById('hrStatus'),
            bpStatus: document.getElementById('bpStatus'),
            fallValue: document.getElementById('fallValue'),
            fallStatus: document.getElementById('fallStatus'),
            activityLog: document.getElementById('activityLog'),
            hrChartUser: document.getElementById('hrChartUser'),
            locationMap: document.getElementById('locationMap'),
            patientMarker: document.getElementById('patientMarker'),
            locationText: document.getElementById('locationText'),
            hrIcon: document.getElementById('hrIcon'), // NEW: For animation
            
            // Shared
            globalAlert: document.getElementById('globalAlert'),
            alertReason: document.getElementById('alertReason'),
            
            // Caretaker Dashboard
            ctHrValue: document.getElementById('ctHrValue'),
            ctBpValue: document.getElementById('ctBpValue'),
            ctLastIncident: document.getElementById('ctLastIncident'),
            caretakerAlertList: document.getElementById('caretakerAlertList'),
            caretakerAlertBadge: document.getElementById('caretakerAlertBadge'),
            hrChartCaretaker: document.getElementById('hrChartCaretaker'),

            // Hospital Dashboard
            hospitalAlertList: document.getElementById('hospitalAlertList'),
            hospitalAlertBadge: document.getElementById('hospitalAlertBadge'),
            hospStatusJohnDoe: document.getElementById('hospStatusJohnDoe'),
            hospVitalsJohnDoe: document.getElementById('hospVitalsJohnDoe'),
            hospIncidentJohnDoe: document.getElementById('hospIncidentJohnDoe'),
            patientRowJohnDoe: document.getElementById('patientRowJohnDoe'),
        };
        
        // --- Audio Alert System (Unchanged) ---
        let synth = null;
        let isPlayingAlarm = false;

        function initializeSynth() {
            if (!synth) {
                synth = new Tone.MembraneSynth({
                    "envelope" : { "attack" : 0.01 , "decay" : 0.4 , "sustain" : 0.01 , "release" : 1.4 , "attackCurve" : "exponential" },
                    "octaves" : 10
                }).toDestination();
                
                document.documentElement.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') { Tone.start(); }
                }, { once: true });
            }
        }

        function playCriticalTone() {
            if (isPlayingAlarm) return;
            initializeSynth();
            
            // Play a distinctive, repeating alarm tone
            const loop = new Tone.Loop(time => {
                synth.triggerAttackRelease("C4", "8n", time);
                synth.triggerAttackRelease("G4", "8n", time + 0.2);
            }, "0.75").start(0); 

            Tone.Transport.start();
            isPlayingAlarm = true;
        }

        function stopCriticalTone() {
            if (!isPlayingAlarm) return;
            Tone.Transport.stop();
            Tone.Transport.cancel(0);
            isPlayingAlarm = false;
        }
        
        // --- D3 Charting Logic (ENHANCED) ---
        const CHART_MARGIN = { top: 10, right: 20, bottom: 30, left: 40 };

        function drawHeartRateChart(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear previous chart
            d3.select(container).selectAll("svg").remove();

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            if (containerWidth === 0 || containerHeight === 0) return; // Don't draw if not visible

            const width = containerWidth - CHART_MARGIN.left - CHART_MARGIN.right;
            const height = containerHeight - CHART_MARGIN.top - CHART_MARGIN.bottom;
            
            const svg = d3.select(container).append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${CHART_MARGIN.left},${CHART_MARGIN.top})`);
            
            // NEW: Define gradient
            const gradient = svg.append("defs").append("linearGradient")
                .attr("id", "hrGradient")
                .attr("x1", "0%").attr("y1", "0%")
                .attr("x2", "0%").attr("y2", "100%");
            gradient.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", "var(--primary)")
                .attr("stop-opacity", 0.4);
            gradient.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", "var(--primary)")
                .attr("stop-opacity", 0);

            // 1. Scales
            const x = d3.scaleTime()
                .domain(d3.extent(Patient.hrHistory, d => d.timestamp))
                .range([0, width]);

            const y = d3.scaleLinear()
                // Y-axis fixed range (50-120 BPM) for medical context stability
                .domain([50, 120]) 
                .range([height, 0]);

            // 2. Axis
            const xAxis = d3.axisBottom(x)
                .ticks(d3.timeMinute.every(5))
                .tickFormat(d3.timeFormat("%H:%M"));
            
            const yAxis = d3.axisLeft(y).ticks(5);

            svg.append("g")
                .attr("class", "axis x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            svg.append("g")
                .attr("class", "axis y-axis")
                .call(yAxis)
                .append("text")
                .attr("fill", "#9CA3AF")
                .attr("transform", "rotate(-90)")
                .attr("y", -25) // Adjusted position
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("BPM");
                
            // 3. Line Generator
            const line = d3.line()
                .x(d => x(d.timestamp))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            // 4. NEW: Area Generator
            const area = d3.area()
                .x(d => x(d.timestamp))
                .y0(height)
                .y1(d => y(d.value))
                .curve(d3.curveMonotoneX);

            // 5. Draw Area
            svg.append("path")
                .datum(Patient.hrHistory)
                .attr("class", "area-heartrate")
                .attr("d", area);

            // 6. Draw Line (on top of area)
            svg.append("path")
                .datum(Patient.hrHistory)
                .attr("class", "line-heartrate")
                .attr("d", line);
        }

        // --- Location Tracking Logic (Unchanged) ---
        function updateLocation() {
            // Update marker position
            const marker = DOMElements.patientMarker;
            marker.style.top = `${Patient.location.y}%`;
            marker.style.left = `${Patient.location.x}%`;
            
            // Update text
            DOMElements.locationText.textContent = `Location: ${Patient.location.room} (${Patient.location.x.toFixed(0)}%, ${Patient.location.y.toFixed(0)}%)`;

            // Randomly move location within bounds (5% to 95%) and room
            if (Patient.status !== 'CRITICAL') {
                Patient.location.x = Math.max(5, Math.min(95, Patient.location.x + (Math.random() - 0.5) * 5));
                Patient.location.y = Math.max(5, Math.min(95, Patient.location.y + (Math.random() - 0.5) * 5));
                
                // Simulate room change based on quadrant
                if (Patient.location.x < 50 && Patient.location.y < 50) Patient.location.room = 'Kitchen';
                else if (Patient.location.x >= 50 && Patient.location.y < 50) Patient.location.room = 'Bedroom';
                else if (Patient.location.x < 50 && Patient.location.y >= 50) Patient.location.room = 'Hallway';
                else Patient.location.room = 'Living Room';
            }
        }


        // --- State Management and Initial Render (UPDATED) ---

        function updateUI() {
            // 1. Update Vitals and Statuses
            DOMElements.hrValue.innerHTML = `${Patient.hr} <span class="text-3xl text-gray-400">BPM</span>`;
            DOMElements.bpValue.innerHTML = `${Patient.bpSystolic}/${Patient.bpDiastolic} <span class="text-3xl text-gray-400">mmHg</span>`;
            DOMElements.fallValue.textContent = Patient.fallDetected ? 'FALL DETECTED' : 'OK';

            // Calculate status colors
            const hrCrit = Patient.hr < 50 || Patient.hr > 110;
            const bpCrit = Patient.bpSystolic > 160 || Patient.bpSystolic < 90 || Patient.bpDiastolic > 100 || Patient.bpDiastolic < 60;
            const isCritical = hrCrit || bpCrit || Patient.fallDetected;

            let overallStatus = 'NORMAL';
            if (isCritical) {
                overallStatus = 'CRITICAL';
            } else if (Patient.hr > 100 || Patient.hr < 60 || Patient.bpSystolic > 140) {
                overallStatus = 'WARNING';
            }

            // Apply color coding (simplified class logic for brevity)
            const hrColor = hrCrit ? 'red' : (Patient.hr > 100 || Patient.hr < 60 ? 'yellow' : 'green');
            const bpColor = bpCrit ? 'red' : (Patient.bpSystolic > 140 ? 'yellow' : 'green');
            const fallColor = Patient.fallDetected ? 'red' : 'green';

            // Update user cards...
            ['hr', 'bp', 'fall'].forEach(v => {
                const card = DOMElements[`${v}Card`];
                const statusEl = DOMElements[`${v}Status`];
                // FIX: Query for the SVG element that Lucide creates
                const icon = v === 'hr' ? DOMElements.hrIcon.querySelector('svg') : card.querySelector('svg');
                const color = v === 'hr' ? hrColor : (v === 'bp' ? bpColor : fallColor);
                
                // Reset classes - Use classList for safety
                card.classList.remove('border-red-500', 'border-yellow-500', 'border-green-500', 'animate-pulse-border-red', 'animate-pulse-border-yellow');
                statusEl.classList.remove('text-red-400', 'text-yellow-400', 'text-green-400');
                if (icon) {
                    icon.classList.remove('text-red-400', 'text-yellow-400', 'text-green-400');
                }

                // Apply new classes
                card.classList.add(`border-${color}-500`);
                statusEl.classList.add(`text-${color}-400`);
                if (icon) {
                    icon.classList.add(`text-${color}-400`);
                }
                
                if (color === 'red') {
                    card.classList.add('animate-pulse-border-red');
                    if (v === 'hr') statusEl.textContent = "Critical Rate";
                    if (v === 'bp') statusEl.textContent = "Critical Pressure";
                    if (v === 'fall') statusEl.textContent = "Incident Detected!";
                } else if (color === 'yellow') {
                    card.classList.add('animate-pulse-border-yellow');
                    if (v === 'hr') statusEl.textContent = "High Rate";
                    if (v === 'bp') statusEl.textContent = "High Pressure";
                } else {
                    if (v === 'hr') statusEl.textContent = "Normal Range";
                    if (v === 'bp') statusEl.textContent = "Normal Range";
                    if (v === 'fall') statusEl.textContent = "No Incident";
                }
            });
            
            // NEW: Update live heartbeat animation
            const hrIconEl = DOMElements.hrIcon.querySelector('svg') || DOMElements.hrIcon;
            if (hrIconEl) {
                const pulseDuration = (60 / Patient.hr).toFixed(2);
                hrIconEl.classList.add('live-heartbeat-icon');
                hrIconEl.style.animationDuration = `${pulseDuration}s`;
            }
            
            // 2. Update Caretaker Vitals
            DOMElements.ctHrValue.textContent = `${Patient.hr} BPM`;
            DOMElements.ctBpValue.textContent = `${Patient.bpSystolic}/${Patient.bpDiastolic} mmHg`;
            // FIXED: Refactored to use classList
            DOMElements.ctHrValue.classList.remove('text-red-400', 'text-yellow-400', 'text-green-400');
            DOMElements.ctHrValue.classList.add(`text-${hrColor}-400`);
            DOMElements.ctBpValue.classList.remove('text-red-400', 'text-yellow-400', 'text-green-400');
            DOMElements.ctBpValue.classList.add(`text-${bpColor}-400`);
            
            // 3. Update Hospital Dashboard
            DOMElements.hospStatusJohnDoe.textContent = overallStatus;
            // FIXED: Refactored to use classList
            DOMElements.hospStatusJohnDoe.classList.remove('text-red-400', 'text-yellow-400', 'text-green-400');
            DOMElements.hospStatusJohnDoe.classList.add(`text-${overallStatus === 'CRITICAL' ? 'red' : (overallStatus === 'WARNING' ? 'yellow' : 'green')}-400`);
            DOMElements.hospVitalsJohnDoe.textContent = `${Patient.hr} BPM / ${Patient.bpSystolic}/${Patient.bpDiastolic}`;
            DOMElements.patientRowJohnDoe.classList.toggle('bg-red-900/50', overallStatus === 'CRITICAL');
            DOMElements.patientRowJohnDoe.classList.toggle('animate-pulse', overallStatus === 'CRITICAL');

            // 4. Update Chart and Location
            // (These are now called separately to avoid re-drawing on every 5s loop if not needed)
        }
        
        // (Function updateAlerts remains unchanged)
        function updateAlerts() {
            // ... (Alerts logic remains the same)
            const listCaretaker = DOMElements.caretakerAlertList;
            const listHospital = DOMElements.hospitalAlertList;
            
            listCaretaker.innerHTML = '';
            listHospital.innerHTML = '';

            const criticalAlerts = Patient.alerts.filter(a => a.severity === 'CRITICAL');
            
            const alertCount = criticalAlerts.length;
            DOMElements.caretakerAlertBadge.textContent = alertCount;
            DOMElements.hospitalAlertBadge.textContent = alertCount;
            DOMElements.caretakerAlertBadge.classList.toggle('hidden', alertCount === 0);
            DOMElements.hospitalAlertBadge.classList.toggle('hidden', alertCount === 0);

            if (alertCount === 0) {
                stopCriticalTone(); 
                listCaretaker.innerHTML = '<li class="p-3 bg-gray-900/50 rounded-lg text-gray-400">No recent critical alerts.</li>';
                listHospital.innerHTML = '<li class="p-3 bg-gray-900/50 rounded-lg text-gray-400">No critical alerts requiring action.</li>';
                DOMElements.globalAlert.classList.add('hidden');
                if (DOMElements.ctLastIncident) { // Check if element exists
                    DOMElements.ctLastIncident.textContent = `None (${formatTime(Patient.lastUpdate)})`;
                }
            } else {
                playCriticalTone(); 
                DOMElements.globalAlert.classList.remove('hidden');
                
                const latestAlert = criticalAlerts[0];
                DOMElements.alertReason.textContent = `${latestAlert.type} Detected! Vitals: HR ${Patient.hr}, BP ${Patient.bpSystolic}/${Patient.bpDiastolic}.`;
                if (DOMElements.ctLastIncident) { // Check if element exists
                    DOMElements.ctLastIncident.textContent = `${latestAlert.type} (${formatTime(latestAlert.timestamp)})`;
                }

                criticalAlerts.forEach(alert => {
                    const listItemHTML = `
                        <li class="alert-pulse p-4 bg-red-900 border-l-4 border-red-500 rounded-lg flex justify-between items-center text-red-100 font-medium">
                            <span>${formatTime(alert.timestamp)} - ${alert.type} (${alert.vitals})</span>
                            <i data-lucide="siren" class="w-5 h-5 ml-4"></i>
                        </li>
                    `;
                    listCaretaker.insertAdjacentHTML('beforeend', listItemHTML);
                    listHospital.insertAdjacentHTML('beforeend', listItemHTML);
                });
                lucide.createIcons(); 
            }
            
            const latestLogEntry = Patient.alerts.length > 0 ? Patient.alerts[0] : { timestamp: Patient.lastUpdate, message: "Readings are nominal." };
            const logHTML = `<p class="${latestLogEntry.severity === 'CRITICAL' ? 'text-red-400 font-bold' : 'text-gray-300'}">[${formatTime(latestLogEntry.timestamp)}] ${latestLogEntry.message}</p>`;
            
            if (DOMElements.activityLog) { // Check if element exists
                DOMElements.activityLog.insertAdjacentHTML('afterbegin', logHTML);
                while (DOMElements.activityLog.children.length > 5) {
                    DOMElements.activityLog.removeChild(DOMElements.activityLog.lastChild);
                }
            }
            
            updateUI();
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // --- NEW: State Broadcasting ---
        function broadcastState() {
            // JSON.stringify automatically converts Date objects to ISO strings
            localStorage.setItem('smartHealthState', JSON.stringify(Patient));
        }

        // --- Alert Simulation and Dismissal (UPDATED) ---
        
        function simulateAlert(type) {
            if (Patient.alerts.length > 0) return;
            
            Patient.status = 'CRITICAL';
            Patient.lastUpdate = new Date();
            let message = '';
            
            if (type === 'Fall Detected') {
                Patient.fallDetected = true;
                message = "Automated: Fall detected and confirmed. Immediate assistance required.";
                // Pin location marker to a corner to simulate impact
                Patient.location.x = 90; 
                Patient.location.y = 90;
                Patient.location.room = 'Ground Floor Fall Zone';
            } else if (type === 'Critical Vitals') {
                Patient.hr = 42; 
                Patient.bpSystolic = 185; 
                Patient.bpDiastolic = 110; 
                message = "Automated: Critical Vitals detected (Extreme Bradychardia/Hypertension). Check HR/BP readings immediately.";
            } else if (type === 'Emergency Button Pressed') {
                 message = "User Pressed Emergency Button. Contacting Caretaker/Hospital.";
            }

            Patient.alerts.unshift({
                timestamp: Patient.lastUpdate,
                type: type,
                severity: 'CRITICAL',
                message: message,
                vitals: `${Patient.hr} BPM, ${Patient.bpSystolic}/${Patient.bpDiastolic} mmHg`
            });

            updateAlerts();
            broadcastState(); // NEW: Broadcast change immediately
        }

        function simulateHealthChange(level) {
            Patient.lastUpdate = new Date();
            
            if (level === 'warn') {
                Patient.hr = 105; // Warning
                Patient.bpSystolic = 155;
                Patient.bpDiastolic = 95;
                Patient.fallDetected = false;
                Patient.status = 'WARNING';
                Patient.alerts.unshift({
                    timestamp: Patient.lastUpdate,
                    type: 'Warning: Elevated Vitals',
                    severity: 'WARNING',
                    message: "Automated: Vitals are elevated. Monitor closely.",
                    vitals: `${Patient.hr} BPM, ${Patient.bpSystolic}/${Patient.bpDiastolic} mmHg`
                });

            } else if (level === 'critical') {
                simulateAlert(Math.random() > 0.5 ? 'Fall Detected' : 'Critical Vitals');
                return; // simulateAlert already broadcasts
            } else {
                Patient.hr = 72;
                Patient.bpSystolic = 120;
                Patient.bpDiastolic = 80;
                Patient.fallDetected = false;
                Patient.status = 'NORMAL';
            }
            
            Patient.alerts = Patient.alerts.filter(a => a.severity === 'CRITICAL');
            
            updateAlerts();
            broadcastState(); // NEW: Broadcast change immediately
        }

        function dismissAlert() {
            stopCriticalTone(); // Ensure audio stops
            Patient.alerts = [];
            Patient.fallDetected = false;
            // Reset vitals to a safe state after incident resolution
            Patient.hr = 75;
            Patient.bpSystolic = 125;
            Patient.bpDiastolic = 85;
            Patient.status = 'NORMAL';
            
            // Reset location to center
            Patient.location.x = 50; 
            Patient.location.y = 50;
            Patient.location.room = 'Living Room';

            updateAlerts();
            broadcastState(); // NEW: Broadcast change immediately
        }
        
        // --- View Switching Logic (UPDATED) ---
        let simulationIntervalID = null; // NEW: Global simulation ID

        function showDashboard(view) {
            document.querySelectorAll('.dashboard-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${view}Dashboard`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('bg-violet-600', 'hover:bg-violet-700');
                btn.classList.add('hover:bg-gray-700');
                // Make non-active buttons transparent glass
                btn.style.backgroundColor = "transparent"; 
            });

            const currentNav = document.getElementById(`nav${view.charAt(0).toUpperCase() + view.slice(1)}`);
            currentNav.classList.remove('hover:bg-gray-700');
            currentNav.classList.add('bg-violet-600', 'hover:bg-violet-700');
            currentNav.style.backgroundColor = ""; // Let CSS classes take over

            // NEW: Simulation & URL Hash Management
            clearInterval(simulationIntervalID); // Stop any simulation
            simulationIntervalID = null;
            
            if (view === 'user') {
                // This tab is now the master. Start the simulation.
                simulationIntervalID = setInterval(() => {
                    if (Patient.status !== 'CRITICAL') {
                        // 1% chance of a random critical event (unnatural situation)
                        if (Math.random() < 0.01) {
                            simulateAlert('Critical Vitals');
                            return; // simulateAlert will broadcast
                        }

                        // Small random variation for normal monitoring
                        Patient.hr = 70 + Math.floor(Math.random() * 10) - 5;
                        Patient.bpSystolic = 115 + Math.floor(Math.random() * 10) - 5;
                        Patient.bpDiastolic = 75 + Math.floor(Math.random() * 10) - 5;
                        Patient.lastUpdate = new Date();
                        
                        // Update HR History array
                        Patient.hrHistory.push({
                            timestamp: Patient.lastUpdate,
                            value: Patient.hr
                        });
                        // Keep history limited to the last 60 points (~5 minutes)
                        if (Patient.hrHistory.length > 60) {
                            Patient.hrHistory.shift();
                        }
                        
                        updateUI(); // Update vitals
                        updateLocation(); // Update location
                        drawHeartRateChart('hrChartUser');

                    } else {
                        // Update location and time only while critical
                        Patient.lastUpdate = new Date();
                        updateUI();
                        updateLocation();
                    }
                    // Broadcast state on every tick
                    broadcastState();
                }, 5000); // 5-second update interval
            }

            // Force chart redraw when changing views to ensure correct sizing
            if (view === 'user' || view === 'caretaker') {
                 // Defer redraw slightly to ensure container dimensions are stable after class removal
                 setTimeout(() => {
                    // Only draw if history has data
                    if(Patient.hrHistory.length > 0) {
                        drawHeartRateChart('hrChartUser');
                        drawHeartRateChart('hrChartCaretaker');
                    }
                 }, 50);
            }
            
            updateUI(); 
            // Update URL hash without reloading page
            window.location.hash = view;
        }
        
        // --- NEW: Storage Event Listener ---
        window.addEventListener('storage', (event) => {
            if (event.key === 'smartHealthState') {
                const activeDashboard = document.querySelector('.dashboard-container:not(.hidden)').id;
                
                // If this tab is the one running the sim, ignore updates
                if (activeDashboard === 'userDashboard') {
                    return;
                }

                try {
                    const newData = JSON.parse(event.newValue);
                    if (!newData) return;

                    // Re-hydrate dates from ISO strings
                    newData.lastUpdate = new Date(newData.lastUpdate);
                    newData.alerts.forEach(a => a.timestamp = new Date(a.timestamp));
                    newData.hrHistory.forEach(h => h.timestamp = new Date(h.timestamp));

                    // Update the local patient object
                    Object.assign(Patient, newData);

                    // Force UI update
                    updateAlerts(); // This will call updateUI
                    
                    // Redraw charts if on a dashboard with a chart
                    if (activeDashboard === 'caretakerDashboard') {
                        drawHeartRateChart('hrChartCaretaker');
                    }
                } catch (e) {
                    console.error("Error processing storage update:", e);
                }
            }
        });

        // --- NEW: Helper to populate initial data ---
        function populateInitialHistory() {
            const now = Date.now();
            for (let i = 20; i >= 1; i--) {
                Patient.hrHistory.push({
                    timestamp: new Date(now - i * 5000), // 5 seconds interval
                    value: 70 + Math.floor(Math.random() * 10) // Base line HR
                });
            }
            if(Patient.hrHistory.length > 0) {
                Patient.hr = Patient.hrHistory[Patient.hrHistory.length - 1].value;
            }
        }
        
        // --- Initialization (UPDATED) ---
        window.onload = function() {
            lucide.createIcons();
            
            // Check for existing state in localStorage
            const existingState = localStorage.getItem('smartHealthState');
            if (existingState) {
                try {
                    const newData = JSON.parse(existingState);
                    // Re-hydrate dates
                    newData.lastUpdate = new Date(newData.lastUpdate);
                    newData.alerts.forEach(a => a.timestamp = new Date(a.timestamp));
                    newData.hrHistory.forEach(h => h.timestamp = new Date(h.timestamp));
                    // Overwrite the default Patient object
                    Object.assign(Patient, newData);
                } catch (e) {
                    console.error("Failed to parse existing state", e);
                    localStorage.removeItem('smartHealthState');
                    populateInitialHistory(); // Populate with defaults
                }
            } else {
                 populateInitialHistory(); // Populate with defaults
            }

            // NEW: URL Hash-based routing
            let initialView = 'user';
            const hash = window.location.hash;
            if (hash === '#caretaker') {
                initialView = 'caretaker';
            } else if (hash === '#hospital') {
                initialView = 'hospital';
            }
            
            showDashboard(initialView); 
            updateAlerts(); // Use this to do the initial UI draw

            // The main simulation interval is now controlled by showDashboard()
        };
    </script>
</body>
</html>